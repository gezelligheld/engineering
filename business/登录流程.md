#### 常见登录方式

- 账号密码登录：收集用户输入的用户名和密码，发送给后端和数据库比对

- 手机验证码、邮箱登录：前端点击发送验证码，把手机号传给后端，后端生成随机数，然后把号码和包含随机数的短信内容都发送给第三方短信平台。邮箱同理

- 第三方账号快捷登录：跳转到第三方登录页面的链接地址，地址拼接了后端加密过后的签名、登录成功后的回跳地址等信息。在第三方页面进行登录时，第三方服务也会生成一个签名并与 url 中的签名对比，如果一致就验证成功，跳转到指定页面

#### 登录验证流程

##### Cookie + Session

流程如下

1. 登录验证成功之后，后端会创建一个 Session 对象然后保存到缓存或者数据库里。Session 表示会话信息，对每个用户标识为不同的 SessionId
2. 在登录接口的响应头中，设置 Set-Cookie 字段，写入 SessionId 和过期时间
3. 之后的请求会自动携带 Cookie，后端接收到请求后将其和 Session 信息对比，如果验证成功就不需要重复登录了

缺点

- 如果 Cookie 被截获，就可以利用 Cookie 信息跳过登录，发起 CSRF 攻击
- 如果把 Session 存在服务器内存，多服务器无法共享，用户量很大的话服务器压力也会增大

##### token

流程如下

1. 登录验证成功之后，后端一般使用 JWT（JSON WEB TOKEN） 将用户信息、签名等加密生成一串字符串，存到数据库并返回给前端
2. 前端存到 Cookie 或 Storage 中，并将 token 信息添加到请求头中
3. 服务端收到请求后与数据库中的信息做对比。或者也可以不存到数据库中，而是对 token 解密出用户信息去校验

JWT 由三部分组成，并以.间隔

- header：声明需要用什么算法生成签名
- payload：一些数据，如过期时间
- signature：将 header 和 payload 进行 base64 编码，再结合 header 声明的算法，生成签名

```
header.payload.signature
```

相比于 Cookie + Session 的方式，token 不需要操作 Session 了

#### 单点登录

单点登录指在一个应用登录账号后可以同时在多个应用上登陆

- 如果同域，把 Cookie 设置给顶级域，这样所有的子域都可以访问该 Cookie 了
- 如果不同域，需要一个认证中心来统一管理或者共享这些状态信息

假设 a.com 和 b.com 需要共享登录状态，其登录流程如下

1. 用户在认证中心提交登录申请，校验通过后生成一个授权码，并将认证中心的登录状态写入 Cookie，然后跳转到 a.com，url 中携带授权码
2. a.com 拿到授权码后向认证中心确认，校验通过后服务端将登录信息写入 Cookie
3. 访问 b.com 重写向到认证中心时发现 Cookie 中存在认证中心的登录状态，直接下发授权码给 b.com
4. b.com 拿到授权码后向认证中心确认，校验通过后服务端将登录信息写入 Cookie

退出登录时，一个应用上退出其他相关应用也要退出，退出登录流程如下

1. a.com 退出登录时，先清空自身的登录状态 Cookie，再携带 Ticket 请求认证中心的退出 api
2. 认证中心验证 Ticket 有效之后，遍历下这个授权码下对应的所有应用，调用对应的退出 api

传到网络上的数据包最终是要传递到客户端或者服务器上的，IP 协议的作用就是让数据包知道往哪里发送

#### IP 地址

IP 地址就是连接网络中的所有主机进行通信的目标地址，因此在网络上的每个主机都需要有自己的 IP 地址。相关概念如下

- 路由器

在 IP 数据报发送的链路中，有可能链路非常长，比如说由中国发往美国的一个数据报，由于网络抖动等一些意外因素可能会导致数据报丢失，这就需要在链路中加入一些中转站，一方面能够确保数据报是否丢失，另一方面能够控制数据报的转发，这些中转站就是路由器

路由器和路由器之间的数据报传送就称为跳，路由器的每一跳都需要询问当前中转的路由器，下一跳应该跳到哪里，从而跳转到目标地址

- MAC 地址

准确的讲，一跳是指从源 MAC 地址到目标 MAC 地址之间传输帧的区间。MAC 地址指的就是计算机的物理地址，用来确认网络设备位置的地址。在 OSI 网络模型中，网络层负责 IP 地址的定位，而数据链路层负责 MAC 地址的定位。MAC 地址用于在网络中唯一标识一个网卡，一台设备若有一或多个网卡，则每个网卡都需要并会有一个唯一的 MAC 地址，也就是说 MAC 地址和网卡是紧密联系在一起的

- IP 地址构造

IP 地址由 网络标识 和 主机标识 两部分组成。网络标识在数据链路的每个段配置不同的值，必须保证相互连接的每个段的地址都不重复，而相同段内相连的主机必须有相同的网络地址。主机标识 则不允许在同一网段内重复出现

- 子网掩码

子网掩码又叫做网络掩码，它是一种用来指明一个 IP 地址的哪些位标识的是主机所在的网络。子网掩码是一个 32 位 地址，用于屏蔽 IP 地址的一部分以区别网络标识和主机标识

如果两个 IP 与同一个子网掩码转换为二进制后按位进行与操作的结果相同，则这两个 IP 属于同一个子网

#### IPv4

IPv4 由 32 位二进制来表示，以 8 位为一组，每组之间以 . 进行分割，再将每组转换为十进制数，取值为[0, 255]，在计算机内部会转化为二进制来处理

IP 地址的总个数有 2^32 个，实际上 IP 不会以主机的个数来配置的，而是根据设备上的 网卡(NIC) 进行配置，每一块网卡都会设置一个或者多个 IP 地址，而且通常一台路由器会有至少两块网卡，所以可以设置两个以上的 IP 地址，所以主机的数量远远达不到 2^32 个

##### IPv4 地址分类

IP 地址分为四类，分别是 A 类、B 类、C 类、D 类、E 类，它会根据 IP 地址中的第 1 位到第 4 位的比特对网络标识和主机标识进行分类

- A 类：1.0.0.0 - 126.0.0.0，第一个字节为网络号，后三个字节为主机号，默认子网掩码：255.0.0.0。该类 IP 地址的最前面为 0 ，所以地址的网络号取值于 1~126 之间。一般用于大型网络
- B 类：128.0.0.0 - 191.255.0.0，前两个字节为网络号，后两个字节为主机号，默认子网掩码：255.255.0.0。该类 IP 地址的最前面为 10 ，所以地址的网络号取值于 128~191 之间。一般用于中等规模网络
- C 类：192.0.0.0 - 223.255.255.0，前三个字节为网络号，最后一个字节为主机号，子网掩码：255.255.255.0。该类 IP 地址的最前面为 110 ，所以地址的网络号取值于 192~223 之间。一般用于小型网络
- D 类：是多播地址。该类 IP 地址的最前面为 1110 ，所以地址的网络号取值于 224~239 之间。一般用于多路广播用户
- E 类：是保留地址。该类 IP 地址的最前面为 1111 ，所以地址的网络号取值于 240~255 之间

对于子网掩码需要说明一下，用 1 表示 IP 网络地址的范围，0 表示 IP 主机地址的范围，之后再转换为十进制，示例如下

```bash
# A类
11111111.00000000.00000000.00000000
# 转换为十进制
255.0.0.0
```

在 IPv4 的几类地址中，有几个保留的地址空间不能在互联网上使用。这些地址用于特殊目的，不能在局域网外部路由，如当前网络（0.0.0.0 - 0.255.255.255）、本地地址（127.0.0.0 - 127.255.255.255）

##### IPv4 分片

每个 IP 数据报封装在链路层帧中从一台路由器传到下一台路由器，链路层能承载的最大数据量称为最大传输单元，当数据报的大小超过最大传输单元时就会在链路层进行分片，每个数据报会在链路层单独封装，形成片。根据数据报首部中含有标识、标志和片偏移等信息，分片后的数据会在目标主机中重组

##### IPv4 寻址

IPv4 支持三种不同类型的寻址模式

- 单播寻址模式：在这种模式下，数据只发送到一个目的地的主机
- 广播寻址模式：在此模式下，数据包将被寻址到网段中的所有主机
- 组播寻址模式：此模式是前两种模式的混合，即发送的数据包既不指向单个主机也不指定段上的所有主机，而指向特定组内的一台计算机

#### IPv6

IPv6 就是为了解决 IPv4 的地址耗尽问题而被标准化的网际协议，由 128 位二进制表示。IPv6 不允许在中间路由器上进行分片和重新组装

##### IPv6 地址

IPv6 地址长度为 128 位，以每 16 比特为一组，并用 : 号进行分隔，如果出现连续的 0 时还可以将 0 省略，并用 :: 两个冒号隔开，一个 IP 地址只允许出现一次两个连续的冒号

```bash
# 二进制示例
1111000011010110 : 1111000011010110 : 1111000011010110 : 1111000011010110 : 1111000011010110 : 1111000011010110 : 1111000011010110 : 1111000011010110
# 十六进制示例
A120 : 0 : 0 : 0 : 8 : 4CD : 126B : 32D
# 简写为
A120 :: 8 : 4CD : 126B : 32D
```

##### IPv6 扩展首部

IPv6 首部长度固定，无法将选项字段加入其中，使用了扩展首部，通常介于 IPv6 首部与 TCP/UDP 首部之间

##### IPv6 特点

- 地址空间变得更大
- 精简报文结构：IPv4 的报文长度不固定，而且有一个不断变化的选项字段；IPv6 报文段固定，并且将选项字段，分片的字段移到了 IPv6 扩展头中
- 层次化的网络结构：IPv6 不再像 IPv4 一样按照 A、B、C 等分类来划分地址，而是通过 IANA -> RIR -> ISP 这样的顺序来分配的。IANA 是国际互联网号码分配机构，RIR 是区域互连网注册管理机构，ISP 是一些运营商（例如电信）
- 支持任播：IPv6 引入了一种新的寻址方式，称为任播寻址

参考

1. [图解 IP 基础知识](https://juejin.cn/post/6908877364130742286)
